name: Publish to PyPI

on:
  workflow_run:
    workflows: ["Tests"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      target:
        description: 'Publish target'
        required: true
        default: 'testpypi'
        type: choice
        options:
          - testpypi
          - pypi

jobs:
  release:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      should_publish: ${{ steps.check.outputs.should_publish }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if release needed
        id: check
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=$(grep '^version' pyproject.toml | head -1 | cut -d'"' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          if gh release view "v$VERSION" &>/dev/null; then
            echo "Release v$VERSION already exists, skipping"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Release v$VERSION does not exist, will create"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Create release
        if: steps.check.outputs.should_publish == 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION=${{ steps.check.outputs.version }}
          gh release create "v$VERSION" --generate-notes --title "v$VERSION"

  build:
    needs: release
    if: needs.release.outputs.should_publish == 'true' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Build frontend
        run: |
          cd web
          mise exec -- bun install
          mise exec -- bun run build

      - name: Build package
        run: uv build --wheel

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  publish-testpypi:
    needs: build
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'testpypi'
    runs-on: ubuntu-latest
    environment: testpypi
    permissions:
      id-token: write
    steps:
      - name: Download dist
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to TestPyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/

  publish-pypi:
    needs: [release, build]
    if: needs.release.outputs.should_publish == 'true' || (github.event_name == 'workflow_dispatch' && github.event.inputs.target == 'pypi')
    runs-on: ubuntu-latest
    environment: pypi
    permissions:
      id-token: write
    steps:
      - name: Download dist
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  publish-docs:
    needs: [release, build]
    if: needs.release.outputs.should_publish == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install mise
        uses: jdx/mise-action@v2

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Build frontend
        run: |
          cd web
          mise exec -- bun install
          mise exec -- bun run build

      - name: Export OpenAPI spec
        run: |
          mkdir -p api
          uv run python scripts/export_openapi.py api/openapi.json

      - name: Generate ReDoc HTML
        run: |
          npx @redocly/cli build-docs api/openapi.json -o api/index.html

      - name: Push to docs site
        env:
          DOCS_DEPLOY_TOKEN: ${{ secrets.DOCS_DEPLOY_TOKEN }}
        run: |
          git clone "https://x-access-token:${DOCS_DEPLOY_TOKEN}@github.com/voicetestdev/voicetestdev.github.io.git" docs-site
          rm -rf docs-site/api
          mv api docs-site/api
          cd docs-site
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add api
          git commit -m "Update API docs for v${{ needs.release.outputs.version }}" || echo "No changes to commit"
          git push
